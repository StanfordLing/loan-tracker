<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>DebtPal - Person</title>
  <link rel="icon" type="image/png" href="icon-192.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="manifest" href="manifest.json">
  <style>
    html,
    body {
      touch-action: pan-x pan-y;
    }

    .borrow {
      color: #dc3545;
    }

    .repay {
      color: #0d6efd;
    }

    .list-group-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .amount-col {
      font-family: monospace;
      text-align: right;
      min-width: 100px;
      display: inline-block;
    }
  </style>
</head>

<body>

  <div class="container">
    <div class="my-3 d-flex align-items-center">
      <a href="dashboard.html" class="btn btn-outline-secondary me-3">‚Üê Back</a>
      <h4 class="m-0 flex-grow-1" id="personName">Loading...</h4>
    </div>

    <div class="card mb-3 shadow-sm">
      <div class="card-body">
        <h5 class="card-title text-muted">Current Balance</h5>
        <h2 id="personBalance">...</h2>
      </div>
    </div>

    <div class="row gx-2 mb-3">
      <div class="col-6">
        <button class="btn btn-danger w-100" onclick="showTxForm('borrow')">Borrow</button>
      </div>
      <div class="col-6">
        <button class="btn btn-primary w-100" onclick="showTxForm('repay')">Repay</button>
      </div>
    </div>

    <ul class="list-group shadow-sm" id="txList"></ul>
  </div>

  <!-- TRANSACTION MODAL -->
  <div class="modal fade" id="txModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Transaction</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="btn-group w-100 mb-2">
            <input type="radio" class="btn-check" name="txType" id="txBorrow" checked>
            <label class="btn btn-outline-danger" for="txBorrow">Borrow (Red)</label>
            <input type="radio" class="btn-check" name="txType" id="txRepay">
            <label class="btn btn-outline-primary" for="txRepay">Repay (Blue)</label>
          </div>
          <input type="number" id="txAmount" class="form-control mb-2" placeholder="Amount" inputmode="decimal">
          <input type="date" id="txDate" class="form-control mb-2">
          <input type="date" id="txDue" class="form-control mb-2" placeholder="Due date (Optional)">
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" onclick="saveTx()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/common.js"></script>
  <script>
    let personId = null;
    let personData = null;

    /* ---------- INIT ---------- */
    async function init() {
      if (!requireAuth()) return;

      // Get ID from URL
      const params = new URLSearchParams(window.location.search);
      personId = params.get('id');

      if (!personId) {
        alert("No person specified");
        window.location.href = 'dashboard.html';
        return;
      }

      const data = await loadData();
      if (data) {
        applyTheme();
        // Find person in current ledger or fallback to default
        // Note: In common.js loadData sets default ledger if null
        // But we need to make sure we find the person across ledgers if we want to be robust, 
        // OR just assume they are in the current active ledger. 
        // For simplicity, we assume current ledger. 
        // If we wanted to support direct links better, we might store ledgerId in URL too.

        if (!appData.ledgers[currentLedger].people[personId]) {
          // Try searching other ledgers
          for (let lid in appData.ledgers) {
            if (appData.ledgers[lid].people[personId]) {
              currentLedger = lid;
              break;
            }
          }
        }

        personData = appData.ledgers[currentLedger].people[personId];

        if (!personData) {
          alert("Person not found");
          window.location.href = 'dashboard.html';
          return;
        }

        render();
        checkAction();
      }
    }
    init();

    function checkAction() {
      const params = new URLSearchParams(window.location.search);
      const action = params.get('action');
      if (action === 'borrow' || action === 'repay') {
        showTxForm(action);
      }
    }

    /* ---------- RENDER ---------- */
    function render() {
      document.getElementById('personName').textContent = personData.name;

      const bal = personData.transactions.reduce((s, t) => s + (t.type === 'borrow' ? t.amount : -t.amount), 0);
      const elBal = document.getElementById('personBalance');
      elBal.textContent = formatCurrency(Math.abs(bal));
      elBal.className = bal > 0 ? 'text-danger' : bal < 0 ? 'text-primary' : 'text-muted';
      if (bal === 0) elBal.textContent = "Settled";

      const txList = document.getElementById('txList');
      txList.innerHTML = '';

      // Sort by date desc
      const sortedTx = [...personData.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

      if (sortedTx.length === 0) {
        txList.innerHTML = '<li class="list-group-item text-center text-muted">No transactions yet</li>';
      }

      sortedTx.forEach(t => {
        txList.innerHTML += `
                <li class="list-group-item">
                    <div class="flex-grow-1 d-flex align-items-center">
                        <span class="${t.type} fw-bold text-uppercase me-2" style="width: 70px;">${t.type}</span>
                        <div class="small text-muted me-auto">${t.date} ${t.due ? `(Due: ${t.due})` : ''}</div>
                        <span class="amount-col fw-bold">${formatCurrency(t.amount)}</span>
                    </div>
                    <button class="btn btn-sm btn-outline-danger border-0 ms-2" onclick="deleteTx('${t.id}')">üóëÔ∏è</button>
                </li>
            `;
      });
    }

    /* ---------- TRANSACTIONS ---------- */
    const txModal = new bootstrap.Modal(document.getElementById('txModal'));

    function showTxForm(type) {
      // Set default based on button clicked
      if (type === 'borrow') document.getElementById('txBorrow').checked = true;
      else if (type === 'repay') document.getElementById('txRepay').checked = true;
      else document.getElementById('txBorrow').checked = true; // Fallback

      document.getElementById('txAmount').value = '';
      document.getElementById('txDate').value = new Date().toISOString().slice(0, 10);
      document.getElementById('txDue').value = '';
      txModal.show();
      setTimeout(() => document.getElementById('txAmount').focus(), 500);
    }

    async function saveTx() {
      const amt = parseFloat(document.getElementById('txAmount').value);
      if (!amt) return;

      const t = {
        id: Date.now(),
        type: document.getElementById('txBorrow').checked ? 'borrow' : 'repay',
        amount: amt,
        date: document.getElementById('txDate').value,
        due: document.getElementById('txDue').value,
        notified: false
      };

      personData.transactions.push(t);
      await saveData();
      render();
      txModal.hide();
    }

    async function deleteTx(id) {
      if (!confirm("Delete this transaction?")) return;
      personData.transactions = personData.transactions.filter(t => t.id != id);
      await saveData();
      render();
    }

    function goBack() {
      // If history exists, go back. Else fallback to dashboard.
      if (history.length > 1) {
        history.back();
      } else {
        window.location.href = 'dashboard.html';
      }
    }
  </script>
</body>

</html>