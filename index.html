<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Loan Tracker</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#007aff">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
:root { --bg:#f4f4f4; --card:#fff; --text:#000; }
.dark { --bg:#121212; --card:#1e1e1e; --text:#fff; }
body { margin:0; font-family:system-ui; background:var(--bg); color:var(--text); }
header { background:#007aff; color:#fff; padding:12px; display:flex; justify-content:space-between; }
.card { background:var(--card); margin:12px; padding:12px; border-radius:8px; }
input,select,button { width:100%; padding:10px; margin:6px 0; }
button { background:#007aff; color:#fff; border:none; border-radius:6px; }
.warn { background:#ffdada; color:#900; padding:10px; margin:12px; border-radius:6px; }
.negative { color:red; }
.overdue { color:red; font-weight:bold; }
</style>
</head>

<body>

<header>
  <strong>Loan Tracker</strong>
  <button onclick="toggleDark()">ðŸŒ™</button>
</header>

<div id="warn" class="warn" style="display:none"></div>

<div id="lock" class="card" style="display:none">
  <h3>Enter PIN</h3>
  <input type="password" id="pinInput">
  <button onclick="unlock()">Unlock</button>
</div>

<div id="app">

<div class="card">
  <h3>Settings</h3>
  <input id="currency" placeholder="Currency (â‚¹ $ â‚¬)">
  <input id="pin" placeholder="Set PIN (optional)">
  <select id="ledger"></select>
  <input id="newLedger" placeholder="New ledger name">
  <button onclick="addLedger()">Add Ledger</button>
  <button onclick="saveSettings()">Save</button>
</div>

<div class="card">
  <h3>Add Transaction</h3>
  <input id="person" placeholder="Person">
  <select id="type">
    <option value="borrow">Borrow</option>
    <option value="repay">Repay</option>
  </select>
  <input id="amount" type="number" placeholder="Amount">
  <input id="due" type="date">
  <button onclick="addTx()">Save</button>
</div>

<div class="card">
  <h3>Balances</h3>
  <div id="balances"></div>
  <strong>Total: <span id="total"></span></strong>
</div>

<div class="card">
  <h3>Chart</h3>
  <canvas id="chart" height="200"></canvas>
</div>

<div class="card">
  <h3>History</h3>
  <div id="history"></div>
</div>

<div class="card">
  <h3>Export</h3>
  <button onclick="exportCSV()">Export CSV</button>
  <button onclick="backup()">Backup JSON</button>
  <input type="file" onchange="restore(event)">
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* ---------- STORAGE TEST ---------- */
function storageOK(){
  try{localStorage.setItem('_t','1');localStorage.removeItem('_t');return true}catch{return false}
}
if(window.self!==window.top || !storageOK()){
  warn.style.display='block';
  warn.innerHTML='âš ï¸ Storage blocked. Use GitHub Pages (not InfinityFree).';
}

/* ---------- DATA ---------- */
let data = JSON.parse(localStorage.getItem('loanApp')||'{}');
data.ledgers ||= { Default:[] };
data.current ||= 'Default';
data.settings ||= { currency:'', dark:false, pin:'' };

/* ---------- LOCK ---------- */
if(data.settings.pin){
  lock.style.display='block';
  app.style.display='none';
}
function unlock(){
  if(pinInput.value===data.settings.pin){
    lock.style.display='none'; app.style.display='block';
  }
}

/* ---------- SETTINGS ---------- */
function save(){
  localStorage.setItem('loanApp',JSON.stringify(data));
  render();
}
function saveSettings(){
  data.settings.currency=currency.value;
  data.settings.pin=pin.value;
  save();
}
function toggleDark(){
  data.settings.dark=!data.settings.dark; save();
}
function addLedger(){
  if(!newLedger.value) return;
  data.ledgers[newLedger.value]=[];
  data.current=newLedger.value;
  newLedger.value='';
  save();
}

/* ---------- TRANSACTIONS ---------- */
function addTx(){
  data.ledgers[data.current].push({
    id:Date.now(),
    p:person.value,
    t:type.value,
    a:+amount.value,
    d:due.value
  });
  person.value=amount.value=due.value='';
  save();
}

/* ---------- EXPORT ---------- */
function exportCSV(){
  let rows=['Person,Type,Amount,Due'];
  data.ledgers[data.current].forEach(t=>{
    rows.push(`${t.p},${t.t},${t.a},${t.d}`);
  });
  let blob=new Blob([rows.join('\n')]);
  let a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='loans.csv';
  a.click();
}
function backup(){
  let blob=new Blob([JSON.stringify(data)]);
  let a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='backup.json';
  a.click();
}
function restore(e){
  let r=new FileReader();
  r.onload=()=>{data=JSON.parse(r.result);save()};
  r.readAsText(e.target.files[0]);
}

/* ---------- RENDER ---------- */
let chart;
function render(){
  document.body.className=data.settings.dark?'dark':'';
  currency.value=data.settings.currency;
  pin.value=data.settings.pin;

  ledger.innerHTML=Object.keys(data.ledgers)
    .map(l=>`<option ${l===data.current?'selected':''}>${l}</option>`).join('');
  ledger.onchange=()=>{data.current=ledger.value;save()};

  let bal={}, total=0;
  let today=new Date().toISOString().slice(0,10);
  history.innerHTML='';
  data.ledgers[data.current].forEach(t=>{
    bal[t.p] ||= 0;
    bal[t.p]+= t.t==='borrow'?t.a:-t.a;
    history.innerHTML+=`
      <div class="${t.d && t.d<today?'overdue':''}">
        ${t.p} ${t.t} ${data.settings.currency}${t.a} ${t.d||''}
      </div>`;
  });

  balances.innerHTML='';
  let labels=[],values=[];
  for(let p in bal){
    balances.innerHTML+=`<div class="${bal[p]<0?'negative':''}">
      ${p}: ${data.settings.currency}${bal[p]}
    </div>`;
    labels.push(p); values.push(bal[p]); total+=bal[p];
  }
  totalSpan.textContent=data.settings.currency+total;

  if(chart) chart.destroy();
  chart=new Chart(document.getElementById('chart'),{
    type:'bar',
    data:{labels,datasets:[{data:values}]}
  });
}
render();

/* ---------- SERVICE WORKER ---------- */
if('serviceWorker'in navigator){
  navigator.serviceWorker.register('sw.js');
}
</script>

</body>
</html>
