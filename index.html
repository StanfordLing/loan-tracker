<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Loan Tracker PWA</title>

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0d6efd">
<style>
body.dark { background:#121212; color:#fff; }
.borrow { color:#dc3545; }
.repay { color:#0d6efd; }
.pointer { cursor:pointer; }
#pinDisplay { letter-spacing: 0.5em; }
</style>
</head>
<body class="bg-light">

<!-- STORAGE WARNING -->
<div id="storageWarning" class="alert alert-danger d-none m-2"></div>

<!-- LOCK SCREEN WITH NUMBER PAD -->
<div id="lockPage" class="container d-flex vh-100 justify-content-center align-items-center">
  <div class="card p-4 w-100 text-center" style="max-width:400px;">
    <h4 class="mb-3">Enter PIN</h4>
    <div id="pinDisplay" class="mb-3 fs-3"></div>
    <div id="pinError" class="form-text text-danger mb-2"></div>
    <div class="row gx-2 gy-2 mb-2">
      <div class="col-4"><button class="btn btn-outline-secondary w-100" onclick="addDigit(1)">1</button></div>
      <div class="col-4"><button class="btn btn-outline-secondary w-100" onclick="addDigit(2)">2</button></div>
      <div class="col-4"><button class="btn btn-outline-secondary w-100" onclick="addDigit(3)">3</button></div>
      <div class="col-4"><button class="btn btn-outline-secondary w-100" onclick="addDigit(4)">4</button></div>
      <div class="col-4"><button class="btn btn-outline-secondary w-100" onclick="addDigit(5)">5</button></div>
      <div class="col-4"><button class="btn btn-outline-secondary w-100" onclick="addDigit(6)">6</button></div>
      <div class="col-4"><button class="btn btn-outline-secondary w-100" onclick="addDigit(7)">7</button></div>
      <div class="col-4"><button class="btn btn-outline-secondary w-100" onclick="addDigit(8)">8</button></div>
      <div class="col-4"><button class="btn btn-outline-secondary w-100" onclick="addDigit(9)">9</button></div>
      <div class="col-4"></div>
      <div class="col-4"><button class="btn btn-outline-secondary w-100" onclick="addDigit(0)">0</button></div>
      <div class="col-4"><button class="btn btn-outline-danger w-100" onclick="delDigit()">‚å´</button></div>
    </div>
    <button class="btn btn-primary w-100 mt-2" onclick="unlockPin()">Unlock</button>
  </div>
</div>

<!-- APP -->
<div id="app" class="container d-none">

<!-- NAV -->
<ul class="nav nav-pills my-3">
  <li class="nav-item"><a class="nav-link active" onclick="route('overview')">Overview</a></li>
  <li class="nav-item"><a class="nav-link" onclick="route('settings')">Settings</a></li>
</ul>

<!-- OVERVIEW -->
<div id="overviewPage">
  <h4>Total Balance: <span id="totalBalance"></span></h4>
  <button class="btn btn-success mb-2" onclick="showAddPerson()">Add Person</button>
  <ul class="list-group" id="peopleList"></ul>
  <hr>
  <button class="btn btn-secondary mb-2" onclick="showAddLedger()">Add Ledger</button>
  <select id="ledgerSelect" class="form-select w-auto d-inline" onchange="switchLedger(this.value)"></select>
</div>

<!-- PERSON PAGE -->
<div id="personPage" class="d-none">
  <button class="btn btn-link" onclick="route('overview')">‚Üê Back</button>
  <h4 id="personName"></h4>
  <p>Balance: <strong id="personBalance"></strong></p>
  <button class="btn btn-success mb-2" onclick="showTxForm()">Add Transaction</button>
  <ul class="list-group" id="txList"></ul>
</div>

<!-- TRANSACTION FORM MODAL -->
<div class="modal fade" id="txModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Transaction</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="btn-group w-100 mb-2">
          <input type="radio" class="btn-check" name="txType" id="txBorrow" checked>
          <label class="btn btn-outline-danger" for="txBorrow">Borrow</label>
          <input type="radio" class="btn-check" name="txType" id="txRepay">
          <label class="btn btn-outline-primary" for="txRepay">Repay</label>
        </div>
        <input type="number" id="txAmount" class="form-control mb-2" placeholder="Amount">
        <input type="date" id="txDate" class="form-control mb-2">
        <input type="date" id="txDue" class="form-control mb-2" placeholder="Due date">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" onclick="saveTx()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- INPUT MODAL (Generic) -->
<div class="modal fade" id="inputModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Title</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="modalInput" class="form-control">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" id="modalSaveBtn">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS -->
<div id="settingsPage" class="d-none">
  <h4>Settings</h4>
  <label>Currency</label>
  <input id="currency" class="form-control mb-2">
  <label>Theme</label>
  <select id="theme" class="form-select mb-2">
    <option value="system">System</option>
    <option value="light">Light</option>
    <option value="dark">Dark</option>
  </select>
  <label>GitHub Token (for cloud sync)</label>
  <input type="password" id="githubToken" class="form-control mb-2" placeholder="Personal Access Token">
  <button class="btn btn-secondary mb-2" onclick="saveSettings()">Save Settings</button>
  <button class="btn btn-warning mb-2" onclick="showChangePin()">Change PIN</button>
  <hr>
  <button class="btn btn-outline-primary" onclick="backup()">Backup</button>
  <input type="file" onchange="restore(event)" class="form-control mt-2">
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ---------- STORAGE CHECK ---------- */
const storageWarning = document.getElementById('storageWarning');
function storageOK(){try{localStorage.setItem('_t','1');localStorage.removeItem('_t');return true}catch{return false}}
if(window.self!==window.top || !storageOK()){storageWarning.classList.remove('d-none'); storageWarning.innerHTML="‚ö†Ô∏è Storage blocked. Use GitHub Pages.";}

/* ---------- DATA ---------- */
let dataEncrypted = localStorage.getItem('loanApp');
let appData = null;
let pinValue = "";
let currentPerson = null;
let currentLedger = null;
let gistId = null;
let githubToken = "";

/* ---------- AES UTIL ---------- */
async function deriveKey(password){
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]);
  return crypto.subtle.deriveKey({name:"PBKDF2",salt:enc.encode("loan-salt"),iterations:100000,hash:"SHA-256"},keyMaterial,{name:"AES-GCM",length:256},false,["encrypt","decrypt"]);
}
async function encryptData(obj,password){
  const key = await deriveKey(password);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const encoded = new TextEncoder().encode(JSON.stringify(obj));
  const cipher = await crypto.subtle.encrypt({name:"AES-GCM",iv},key,encoded);
  return {iv:Array.from(iv),data:Array.from(new Uint8Array(cipher))};
}
async function decryptData(payload,password){
  const key = await deriveKey(password);
  const iv = new Uint8Array(payload.iv);
  const data = new Uint8Array(payload.data);
  const decrypted = await crypto.subtle.decrypt({name:"AES-GCM",iv},key,data);
  return JSON.parse(new TextDecoder().decode(decrypted));
}

/* ---------- PIN LOCK ---------- */
const pinDisplay = document.getElementById('pinDisplay');
const pinError = document.getElementById('pinError');
function addDigit(d){if(pinValue.length>=12)return; pinValue+=d; updateDisplay();}
function delDigit(){pinValue=pinValue.slice(0,-1); updateDisplay();}
function updateDisplay(){pinDisplay.textContent="‚óè".repeat(pinValue.length); pinError.textContent="";}
async function unlockPin(){
  if(pinValue.length<6){pinError.textContent="PIN must be at least 6 digits."; return;}
  if(!dataEncrypted){appData={ledgers:{default:{name:'Personal',people:{}}},settings:{currency:'‚Çπ',theme:'system'}}; currentLedger='default'; persist(); showApp(); return;}
  try{appData = await decryptData(JSON.parse(dataEncrypted),pinValue); currentLedger=Object.keys(appData.ledgers)[0]; githubToken = appData.settings.githubToken||""; showApp(); render(); if(githubToken) syncFromGist(); checkReminders();}catch(e){pinError.textContent="Incorrect PIN"; pinValue=""; updateDisplay();}
}
function showApp(){document.getElementById('lockPage').classList.add('d-none'); document.getElementById('app').classList.remove('d-none');}

/* ---------- ROUTING ---------- */
function route(page){['overview','person','tx','settings'].forEach(p=>document.getElementById(p+'Page').classList.add('d-none'));document.getElementById(page+'Page').classList.remove('d-none');}

/* ---------- MODAL INPUT ---------- */
let modalCallback=null;
const inputModal=new bootstrap.Modal(document.getElementById('inputModal'));
function showModal(title, placeholder, defaultValue, callback){
  document.getElementById('modalTitle').textContent=title;
  const input=document.getElementById('modalInput');
  input.placeholder=placeholder||'';
  input.value=defaultValue||'';
  modalCallback=callback;
  inputModal.show();
  input.focus();
}
document.getElementById('modalSaveBtn').onclick=function(){if(modalCallback) modalCallback(document.getElementById('modalInput').value); inputModal.hide();}

/* ---------- CHANGE PIN ---------- */
function showChangePin(){
  showModal("Change PIN","Enter new 6-digit PIN","",async newPin=>{
    if(!newPin || newPin.length < 6){alert("PIN must be at least 6 digits."); return;}
    const currentPin = prompt("Enter current PIN to confirm:");
    if(!currentPin) return;
    try{
      await decryptData(JSON.parse(localStorage.getItem('loanApp')), currentPin);
      pinValue = newPin;
      persist();
      alert("PIN changed successfully!");
    }catch(e){
      alert("Incorrect current PIN. Cannot change.");
    }
  });
}

/* ---------- RENDER ---------- */
function render(){
  const themeVal = appData.settings.theme;
  document.body.className = themeVal==='dark' ? 'dark' : themeVal==='light' ? '' : (matchMedia('(prefers-color-scheme: dark)').matches?'dark':'');
  document.getElementById('currency').value=appData.settings.currency;
  document.getElementById('theme').value=themeVal;
  document.getElementById('githubToken').value=appData.settings.githubToken||"";

  const ledger = appData.ledgers[currentLedger];
  const select = document.getElementById('ledgerSelect');
  select.innerHTML='';
  Object.keys(appData.ledgers).forEach(id=>select.innerHTML+=`<option value="${id}" ${id===currentLedger?'selected':''}>${appData.ledgers[id].name}</option>`);

  let total=0;
  const peopleList = document.getElementById('peopleList');
  peopleList.innerHTML='';
  for(let pid in ledger.people){
    let bal=ledger.people[pid].transactions.reduce((s,t)=>s+(t.type==='borrow'?t.amount:-t.amount),0);
    total+=bal;
    peopleList.innerHTML+=`<li class="list-group-item pointer" onclick="openPerson('${pid}')">${ledger.people[pid].name}<span class="float-end">${appData.settings.currency}${bal}</span></li>`;
  }
  document.getElementById('totalBalance').textContent=appData.settings.currency+total;
}

/* ---------- PERSON ---------- */
function openPerson(pid){currentPerson=pid; const p=appData.ledgers[currentLedger].people[pid]; document.getElementById('personName').textContent=p.name; const bal=p.transactions.reduce((s,t)=>s+(t.type==='borrow'?t.amount:-t.amount),0); document.getElementById('personBalance').textContent=appData.settings.currency+bal; const txList=document.getElementById('txList'); txList.innerHTML=''; p.transactions.forEach(t=>txList.innerHTML+=`<li class="list-group-item ${t.type}">${t.type} ${appData.settings.currency}${t.amount} (${t.date}) <span class="float-end pointer text-danger" onclick="deleteTx('${t.id}')">üóëÔ∏è</span></li>`); route('person');}

/* ---------- TRANSACTIONS ---------- */
function showTxForm(){new bootstrap.Modal(document.getElementById('txModal')).show();}
function saveTx(){const ledger=appData.ledgers[currentLedger]; const p=ledger.people[currentPerson]; const t={id:Date.now(),type:document.getElementById('txBorrow').checked?'borrow':'repay',amount:+document.getElementById('txAmount').value,date:document.getElementById('txDate').value,due:document.getElementById('txDue').value,notified:false}; p.transactions.push(t); persist(); openPerson(currentPerson);}
function deleteTx(id){const ledger=appData.ledgers[currentLedger]; ledger.people[currentPerson].transactions=ledger.people[currentPerson].transactions.filter(t=>t.id!=id); persist(); openPerson(currentPerson);}

/* ---------- ADD / RENAME / DELETE ---------- */
function showAddPerson(){showModal("Add Person","Person name","",name=>{if(!name) return; const id=Date.now(); appData.ledgers[currentLedger].people[id]={name,transactions:[]}; persist(); render();});}
function showAddLedger(){showModal("Add Ledger","Ledger name","",name=>{if(!name) return; const id=Date.now(); appData.ledgers[id]={name,people:{}}; currentLedger=id; persist(); render();});}
function switchLedger(id){currentLedger=id; render();}

/* ---------- SETTINGS ---------- */
function saveSettings(){appData.settings.currency=document.getElementById('currency').value; appData.settings.theme=document.getElementById('theme').value; appData.settings.githubToken=document.getElementById('githubToken').value; githubToken=appData.settings.githubToken; persist(); if(githubToken) syncToGist();}

/* ---------- BACKUP / RESTORE ---------- */
function backup(){const blob=new Blob([JSON.stringify(appData)]); const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='loan-backup.json';a.click();}
function restore(e){const r=new FileReader(); r.onload=()=>{appData=JSON.parse(r.result);persist();}; r.readAsText(e.target.files[0]);}

/* ---------- PERSIST ---------- */
async function persist(){const encrypted=await encryptData(appData,pinValue); localStorage.setItem('loanApp',JSON.stringify(encrypted)); render(); if(githubToken) syncToGist(); checkReminders();}

/* ---------- CLOUD SYNC ---------- */
async function syncToGist(){if(!gistId){const res=await fetch('https://api.github.com/gists',{method:'POST',headers:{Authorization:`token ${githubToken}`, 'Content-Type':'application/json'},body:JSON.stringify({public:false,description:"LoanTracker Backup",files:{"loan-backup.json":{content:JSON.stringify(await encryptData(appData,pinValue))}}})}); const gist=await res.json(); gistId=gist.id;}else{await fetch(`https://api.github.com/gists/${gistId}`,{method:'PATCH',headers:{Authorization:`token ${githubToken}`, 'Content-Type':'application/json'},body:JSON.stringify({files:{"loan-backup.json":{content:JSON.stringify(await encryptData(appData,pinValue))}}})})}}
async function syncFromGist(){if(!gistId) return; const res=await fetch(`https://api.github.com/gists/${gistId}`,{headers:{Authorization:`token ${githubToken}`}}); const gist=await res.json(); const file=gist.files['loan-backup.json'].content; appData=await decryptData(JSON.parse(file),pinValue); persist();}

/* ---------- OVERDUE NOTIFICATIONS ---------- */
function checkReminders(){
  if(Notification.permission!=='granted') return;
  const today=new Date().toISOString().slice(0,10);
  const ledger=appData.ledgers[currentLedger];
  for(let person of Object.values(ledger.people)){
    person.transactions.forEach(t=>{
      if(t.due && t.due<today && t.type==='borrow' && !t.notified){
        new Notification('Overdue Loan',{body:`${person.name} is overdue for ${appData.settings.currency}${t.amount}`});
        t.notified=true;
      }
    });
  }
  persist();
}
if(Notification.permission!=='granted') Notification.requestPermission();

</script>
</body>
</html>
